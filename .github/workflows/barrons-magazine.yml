name: Barron's Magazine (Weekly)

on:
  workflow_dispatch:
  
  # Every Saturday at 12 PM UTC (7 AM EST)
  schedule:
    - cron: '0 12 * * 6'

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install -y calibre

      - name: Fetch Barron's Magazine
        env:
          BARRONS_USERNAME: ${{ secrets.BARRONS_USERNAME }}
          BARRONS_PASSWORD: ${{ secrets.BARRONS_PASSWORD }}
        run: |
          ebook-convert "Barron's Magazine.recipe" barrons-magazine.epub \
            --username "$BARRONS_USERNAME" \
            --password "$BARRONS_PASSWORD" \
            --output-profile kindle_oasis

      - name: Send to Kindle via Gmail
        env:
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          KINDLE_EMAIL: ${{ secrets.KINDLE_EMAIL }}
        run: |
          python3 << 'EOF'
          import smtplib
          import os
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email import encoders
          from datetime import datetime

          gmail_user = os.environ['GMAIL_USERNAME']
          gmail_pass = os.environ['GMAIL_APP_PASSWORD']
          kindle_email = os.environ['KINDLE_EMAIL']

          msg = MIMEMultipart()
          msg['From'] = gmail_user
          msg['To'] = kindle_email
          msg['Subject'] = f"Barron's Magazine - {datetime.now().strftime('%Y-%m-%d')}"

          with open('barrons-magazine.epub', 'rb') as f:
              part = MIMEBase('application', 'octet-stream')
              part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header('Content-Disposition', 'attachment', filename='barrons-magazine.epub')
              msg.attach(part)

          with smtplib.SMTP('smtp.gmail.com', 587) as server:
              server.starttls()
              server.login(gmail_user, gmail_pass)
              server.send_message(msg)

          print("Sent Barron's Magazine to Kindle!")
          EOF
